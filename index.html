<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Explorateur de Friches - Grand Est</title>
    
    <!-- Bibliothèques externes -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <style>
        body, html { height: 100%; margin: 0; font-family: 'Inter', sans-serif; }
        #map { height: 100vh; width: 100%; }
        
        .floating-panel {
            position: absolute; top: 20px; left: 20px; z-index: 1000;
            background: white; padding: 20px; border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            width: 300px;
        }
        
        .legend-dot {
            height: 12px; width: 12px; border-radius: 50%; display: inline-block; margin-right: 8px;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div class="floating-panel">
        <h1 class="text-xl font-bold text-gray-800 mb-2">Friches du Grand Est</h1>
        <p class="text-sm text-gray-600 mb-4">Visualisation des sites répertoriés à partir de la base de données CSV.</p>
        
        <div id="stats" class="text-sm font-medium text-blue-600 bg-blue-50 p-3 rounded-lg border border-blue-100">
            Chargement des données...
        </div>

        <div class="mt-4 pt-4 border-t border-gray-100">
            <h2 class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2">Légende</h2>
            <div class="flex items-center text-sm text-gray-700 mb-1">
                <span class="legend-dot bg-blue-500"></span> Site identifié
            </div>
        </div>
    </div>

    <div id="map"></div>

    <script>
        // 1. Initialisation de la carte
        const map = L.map('map').setView([48.6, 7.5], 9); // Centré par défaut sur l'Alsace/Grand Est

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        // 2. Fonction pour extraire les coordonnées du format "POINT (X Y)"
        function parseWKT(wktString) {
            if (!wktString) return null;
            // Utilise une expression régulière pour capturer les nombres à l'intérieur des parenthèses
            const match = wktString.match(/\(([^)]+)\)/);
            if (match) {
                const parts = match[1].trim().split(/\s+/);
                if (parts.length >= 2) {
                    const lng = parseFloat(parts[0]);
                    const lat = parseFloat(parts[1]);
                    return { lat, lng };
                }
            }
            return null;
        }

        // 3. Chargement et traitement du CSV
        const csvFile = "BD_GEMINI_TEST_CSV.csv";

        Papa.parse(csvFile, {
            download: true,
            header: true,
            delimiter: ";", // Spécifié car votre fichier utilise le point-virgule
            skipEmptyLines: true,
            complete: function(results) {
                const data = results.data;
                let count = 0;
                const markers = [];

                data.forEach((row, index) => {
                    // Extraction des coordonnées depuis la colonne 'geompoint'
                    const coords = parseWKT(row.geompoint);

                    if (coords && !isNaN(coords.lat) && !isNaN(coords.lng)) {
                        // Création du marqueur
                        // Note : Leaflet prend [lat, lng]
                        const marker = L.marker([coords.lat, coords.lng])
                            .bindPopup(`
                                <div class="font-sans">
                                    <h3 class="font-bold text-lg text-blue-700">${row.site_nom || 'Sans nom'}</h3>
                                    <p class="text-sm"><b>Type :</b> ${row.site_type || 'Non spécifié'}</p>
                                    <p class="text-sm"><b>Adresse :</b> ${row.site_adresse || 'N/A'}</p>
                                    <p class="text-xs mt-2 text-gray-500 italic">ID: ${row.site_id}</p>
                                </div>
                            `);
                        
                        marker.addTo(map);
                        markers.push(marker);
                        count++;
                    } else {
                        console.warn(`Ligne ${index + 1} ignorée : coordonnées invalides`, row.geompoint);
                    }
                });

                // Ajuster la vue si des marqueurs ont été ajoutés
                if (markers.length > 0) {
                    const group = new L.featureGroup(markers);
                    map.fitBounds(group.getBounds().pad(0.1));
                }

                // Mise à jour de l'interface
                document.getElementById('stats').innerText = `${count} sites affichés avec succès`;
            },
            error: function(err) {
                console.error("Erreur lors du chargement du CSV:", err);
                document.getElementById('stats').innerHTML = `<span class="text-red-500">Erreur de chargement du fichier CSV</span>`;
            }
        });
    </script>
</body>
</html>